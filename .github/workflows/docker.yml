name: Docker Image Build and Deploy

on: push
	# schedule:
	# 	- cron: '16 18 * * *'
	# push:
	# 	branches: [ "main" ]
	# 	# Publish semver tags as releases.
	# 	tags: [ 'v*.*.*' ]
	# pull_request:
	# 	branches: [ "main" ]

jobs:
	build:

		runs-on: ubuntu-latest
		permissions:
			contents: read
			packages: write
			# This is used to complete the identity challenge
			# with sigstore/fulcio when running outside of PRs.
			id-token: write

		steps:
			- name: Checkout repository
				uses: actions/checkout@v3

			# https://github.com/sigstore/cosign-installer
			- name: Install cosign
				# if: github.event_name != 'pull_request'
				uses: sigstore/cosign-installer@v3.1.1
				with:
					cosign-release: 'v2.1.1'

			# https://github.com/docker/setup-buildx-action
			- name: Set up Docker Buildx
				uses: docker/setup-buildx-action@v3

			# # https://github.com/docker/login-action#docker-hub
			# - name: Login to Docker Hub
			# 	uses: docker/login-action@v3
			# 	with:
			# 	username: ${{ secrets.DOCKERHUB_USERNAME }}
			# 	password: ${{ secrets.DOCKERHUB_TOKEN }}

			# https://github.com/docker/login-action#github-container-registry
			- name: Log into registry GitHub Container Registry
				if: github.event_name != 'pull_request'
				uses: docker/login-action@v3
				with:
					registry: ${{ var.REGISTRY }}
					username: ${{ github.actor }}
					password: ${{ secrets.GITHUB_TOKEN }}

			# https://github.com/docker/metadata-action
			- name: Extract Docker metadata
				id: meta
				uses: docker/metadata-action@v5
				with:
					images: ${{ var.REGISTRY }}/${{ var.IMAGE_NAME }}

			# https://github.com/docker/build-push-action
			- name: Build and push Docker image
				id: build-and-push
				uses: docker/build-push-action@v5
				with:
					context: .
					# push: ${{ github.event_name != 'pull_request' }}
					push: true
					tags: ${{ steps.meta.outputs.tags }}
					labels: ${{ steps.meta.outputs.labels }}
					cache-from: type=gha
					cache-to: type=gha,mode=max

			# https://github.com/sigstore/cosign
			- name: Sign the published Docker image
				# if: ${{ github.event_name != 'pull_request' }}
				env:
					# https://docs.github.com/en/actions/security-guides/security-hardening-for-github-actions#using-an-intermediate-environment-variable
					TAGS: ${{ steps.meta.outputs.tags }}
					DIGEST: ${{ steps.build-and-push.outputs.digest }}
				# This step uses the identity token to provision an ephemeral certificate
				# against the sigstore community Fulcio instance.
				run: echo "${TAGS}" | xargs -I {} cosign sign --yes {}@${DIGEST}
